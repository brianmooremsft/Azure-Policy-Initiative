{
 "properties": {
  "displayName": "Non Prod MTB Monitoring Initiative",
  "policyType": "Custom",
  "metadata": {
   "category": "Monitoring",
   "createdBy": "38fdcff3-7387-41e2-8517-dea0eb1043a3",
   "createdOn": "2022-12-09T05:13:22.8826649Z",
   "updatedBy": null,
   "updatedOn": null
  },
  "parameters": {
   "profileName": {
    "type": "String",
    "metadata": {
     "displayName": "Profile name",
     "description": "The diagnostic settings profile name"
    },
    "defaultValue": "setbypolicy_logAnalytics"
   },
   "logsEnabled": {
    "type": "String",
    "metadata": {
     "displayName": "Enable logs",
     "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
    },
    "allowedValues": [
     "True",
     "False"
    ],
    "defaultValue": "True"
   },
   "managementLogAnalyticsWorkspace": {
    "type": "string",
    "metadata": {
     "displayName": "Log Analytics Workspace for Management",
     "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
     "strongType": "omsWorkspace",
     "assignPermissions": true
    }
   },
   "keyVaulteffect": {
    "type": "String",
    "metadata": {
     "displayName": "Effect",
     "description": "Enable or disable the execution of the policy"
    },
    "allowedValues": [
     "DeployIfNotExists",
     "Disabled"
    ],
    "defaultValue": "DeployIfNotExists"
   },
   "keyVaultDiagnosticsmetricsEnabled": {
    "type": "String",
    "metadata": {
     "displayName": "Enable metrics",
     "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
    },
    "allowedValues": [
     "True",
     "False"
    ],
    "defaultValue": "True"
   },
   "keyVaultMatchWorkspace": {
    "type": "Boolean",
    "metadata": {
     "displayName": "Workspace id must match",
     "description": "Whether to require that the workspace of the diagnostic settings matches the workspace deployed by this policy"
    },
    "allowedValues": [
     true,
     false
    ],
    "defaultValue": false
   },
   "azureActivityeffect": {
    "type": "String",
    "metadata": {
     "displayName": "Effect",
     "description": "Enable or disable the execution of the policy"
    },
    "allowedValues": [
     "DeployIfNotExists",
     "Disabled"
    ],
    "defaultValue": "DeployIfNotExists"
   },
   "nsgRegion": {
    "type": "String",
    "metadata": {
     "displayName": "NSG Region",
     "description": "This Policy will review NSGs only in the selected region. You can create other assignments to include other regions.",
     "strongType": "location"
    }
   },
   "storageId": {
    "type": "String",
    "metadata": {
     "displayName": "Storage id",
     "description": "A string with the storage id for the flowlogs to be sent to. It will be used for deployment purposes only. Make sure this storage account is located in the same region as the NSG. The format must be: '/subscriptions/{subscription id}/resourceGroups/{resourceGroup name}/providers/Microsoft.Storage/storageAccounts/{storage account name}",
     "assignPermissions": true
    }
   },
   "networkWatcherRG": {
    "type": "String",
    "metadata": {
     "displayName": "Network Watchers RG",
     "description": "The name of the resource group where the flowLog resources will be created. This will be used only if a deployment is required. This is the resource group where the Network Watchers are located.",
     "strongType": "existingResourceGroups"
    }
   },
   "networkWatcherName": {
    "type": "String",
    "metadata": {
     "displayName": "Network Watcher name",
     "description": "The name of the network watcher under which the flowLog resources will be created. Make sure it belongs to the same region as the NSG."
    }
   }
  },
  "policyDefinitions": [
   {
    "policyDefinitionReferenceId": "Deploy a flow log resource with target network security group",
    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/0db34a60-64f4-4bf6-bd44-f95c16cf34b9",
    "parameters": {
     "nsgRegion": {
      "value": "[parameters('nsgRegion')]"
     },
     "storageId": {
      "value": "[parameters('storageId')]"
     },
     "networkWatcherRG": {
      "value": "[parameters('networkWatcherRG')]"
     },
     "networkWatcherName": {
      "value": "[parameters('networkWatcherName')]"
     }
    }
   },
   {
    "policyDefinitionReferenceId": "Configure Azure Activity logs to stream to specified Log Analytics workspace_1",
    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/2465583e-4e78-4c15-b6be-a36cbc7c8b0f",
    "parameters": {
     "logAnalytics": {
      "value": "[parameters('managementLogAnalyticsWorkspace')]"
     },
     "effect": {
      "value": "[parameters('azureActivityeffect')]"
     },
     "logsEnabled": {
      "value": "[parameters('logsEnabled')]"
     }
    }
   },
   {
    "policyDefinitionReferenceId": "Deploy Diagnostic Settings for Key Vault to Log Analytics workspace_1",
    "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bef3f64c-5290-43b7-85b0-9b254eef4c47",
    "parameters": {
     "logAnalytics": {
      "value": "[parameters('managementLogAnalyticsWorkspace')]"
     },
     "effect": {
      "value": "[parameters('keyVaulteffect')]"
     },
     "metricsEnabled": {
      "value": "[parameters('keyVaultDiagnosticsmetricsEnabled')]"
     },
     "logsEnabled": {
      "value": "[parameters('logsEnabled')]"
     },
     "profileName": {
      "value": "[parameters('profileName')]"
     },
     "matchWorkspace": {
      "value": "[parameters('keyVaultMatchWorkspace')]"
     }
    }
   }
  ]
 },
 "id": "/subscriptions/501b9bfd-98f9-4c31-af58-cd753197912a/providers/Microsoft.Authorization/policySetDefinitions/Monitoring-Policies",
 "type": "Microsoft.Authorization/policySetDefinitions",
 "name": "Monitoring-Policies"
}